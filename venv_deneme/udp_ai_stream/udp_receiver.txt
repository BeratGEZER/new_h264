import socket
import cv2
import numpy as np
import threading
import time


class ReceiverManager:
    def __init__(self):
        self.receivers = {}


    def start_receiver(self, udp_port):
        if udp_port in self.receivers:
            print(f"âš ï¸ UDP {udp_port} zaten dinleniyor.")
            return


        t = threading.Thread(target=self.receive_stream, args=(udp_port,))
        t.start()
        self.receivers[udp_port] = t
        print(f"âœ… UDP {udp_port} alÄ±cÄ± baÅŸlatÄ±ldÄ±.")


    def receive_stream(self, udp_port):
        sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        sock.bind(("0.0.0.0", udp_port))
        print(f"ğŸ¥ Dinleniyor: UDP {udp_port}")


        buffer = b""
        paket_sayisi = 0
        alinan_toplam_byte = 0
        son_veri_zamani = time.time()


        while True:
            try:
                data, _ = sock.recvfrom(65536)
                buffer += data
                paket_sayisi += 1
                alinan_toplam_byte += len(data)


                port_data = int(udp_port) - 4000
                print(f"[video {port_data}] ğŸ“¦ Paket {paket_sayisi} â†’ {len(data)} byte")


                now = time.time()
                if now - son_veri_zamani > 1:
                    print(f"âš ï¸ [UDP {udp_port}] 1 saniyedir veri alÄ±nmÄ±yor!")
                son_veri_zamani = now


                if len(data) < 60000:
                    frame_data = np.frombuffer(buffer, dtype=np.uint8)
                    frame = cv2.imdecode(frame_data, cv2.IMREAD_COLOR)
                    if frame is not None:
                        frame = cv2.resize(frame, (200, 100))
                        cv2.imshow(f"UDP Stream {udp_port}", frame)
                        if cv2.waitKey(1) & 0xFF == ord('q'):
                            break
                    buffer = b""
            except Exception as e:
                print(f"â›” Hata (UDP {udp_port}): {e}")
                break


            print(f"ğŸ“¥ AlÄ±nan Paket SayÄ±sÄ±: {paket_sayisi}")
            print(f"ğŸ“¥ AlÄ±nan Toplam Veri: {alinan_toplam_byte} B â‰ˆ {alinan_toplam_byte/1024:.2f} KB")


       


if __name__ == "__main__":
    manager = ReceiverManager()
    ports_to_listen = [4001, 4002, 4003]
    for port in ports_to_listen:
        manager.start_receiver(port)